#!/bin/bash
# Pre-push hook: ãƒ—ãƒƒã‚·ãƒ¥å‰ã«ãƒ†ã‚¹ãƒˆã¨ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œ

echo "ğŸš€ Running pre-push checks..."
echo ""

# ktlintãƒã‚§ãƒƒã‚¯
echo "ğŸ“ Running ktlint..."
./gradlew ktlintCheck --daemon
KTLINT_RESULT=$?

if [ $KTLINT_RESULT -ne 0 ]; then
    echo ""
    echo "âŒ ktlint check failed"
    echo ""
    echo "ğŸ’¡ Fix suggestions:"
    echo "   1. Auto-fix formatting:"
    echo "      ./gradlew ktlintFormat"
    echo ""
    echo "   2. Then commit:"
    echo "      git add . && git commit -m 'Fix formatting'"
    echo ""
    echo "   3. If you want to push anyway (not recommended):"
    echo "      git push --no-verify"
    echo ""
    exit 1
fi

echo "âœ… ktlint passed"
echo ""

# detekt
echo "ğŸ” Running detekt..."
./gradlew detekt --daemon
DETEKT_RESULT=$?

if [ $DETEKT_RESULT -ne 0 ]; then
    echo ""
    echo "âŒ detekt check failed"
    echo ""
    echo "ğŸ’¡ Fix suggestions:"
    echo "   1. View the report:"
    echo "      open build/reports/detekt/detekt.html"
    echo ""
    echo "   2. Fix issues and commit"
    echo ""
    exit 1
fi

echo "âœ… detekt passed"
echo ""

# ãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆKMPç”¨ã«allTestsä½¿ç”¨ï¼‰
echo "ğŸ§ª Running tests..."
./gradlew allTests --daemon || ./gradlew check --daemon
TEST_RESULT=$?

if [ $TEST_RESULT -ne 0 ]; then
    echo ""
    echo "âŒ Tests failed"
    echo ""
    echo "ğŸ’¡ Fix suggestions:"
    echo "   1. Run tests locally:"
    echo "      ./gradlew allTests --info"
    echo ""
    echo "   2. Or run specific platform tests:"
    echo "      ./gradlew jvmTest jsTest wasmJsTest"
    echo ""
    echo "   3. Skip tests (not recommended):"
    echo "      git push --no-verify"
    echo ""
    exit 1
fi

echo "âœ… tests passed"
echo ""
echo "========================================="
echo "âœ… All pre-push checks passed! Proceeding with push..."
echo "========================================="
exit 0
